<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/black-vue-guidebook/umi.5b68fcee.css" />
    <script>
      window.routerBase = "/black-vue-guidebook/";
    </script>
    <script>
      //! umi version: 3.5.17
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>响应性原理</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/infrastructure/vue3/reactivity" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;https://img.mrsingsing.com/vue-guidebook-logo.png&#x27;)" href="/black-vue-guidebook//">Vue Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/black-vue-guidebook//overview">基础</a></span><span><a aria-current="page" class="active" href="/black-vue-guidebook//infrastructure">架构</a></span><span><a href="/black-vue-guidebook//ecosystem">生态</a></span><span><a href="/black-vue-guidebook//extensions">扩展</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-vue-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;https://img.mrsingsing.com/vue-guidebook-logo.png&#x27;)" href="/black-vue-guidebook//"></a><h1>Vue Guidebook</h1><p>Vue 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/black-vue-guidebook//overview">基础</a></li><li><a aria-current="page" class="active" href="/black-vue-guidebook//infrastructure">架构</a></li><li><a href="/black-vue-guidebook//ecosystem">生态</a></li><li><a href="/black-vue-guidebook//extensions">扩展</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-vue-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a aria-current="page" class="active" href="/black-vue-guidebook//infrastructure/vue3">Vue3 架构</a><ul><li><a href="/black-vue-guidebook//infrastructure/vue3/overview"><span>框架分析</span></a></li><li><a aria-current="page" class="active" href="/black-vue-guidebook//infrastructure/vue3/reactivity"><span>响应性原理</span></a></li><li><a href="/black-vue-guidebook//infrastructure/vue3/leftcycle"><span>生命周期</span></a></li><li><a href="/black-vue-guidebook//infrastructure/vue3/compile-flow"><span>代码编译</span></a></li></ul></li><li><a href="/black-vue-guidebook//infrastructure/vue2">Vue2 架构</a><ul><li><a href="/black-vue-guidebook//infrastructure/vue2/reactivity"><span>响应式原理</span></a></li><li><a href="/black-vue-guidebook//infrastructure/vue2/path-update"><span>批量更新策略</span></a></li><li><a href="/black-vue-guidebook//infrastructure/vue2/next-tick"><span>nextTick</span></a></li><li><a href="/black-vue-guidebook//infrastructure/vue2/lifecycle"><span>生命周期</span></a></li><li><a href="/black-vue-guidebook//infrastructure/vue2/virtual-dom"><span>虚拟 DOM</span></a></li></ul></li><li><a href="/black-vue-guidebook//infrastructure/ssr">服务端渲染</a></li><li><a href="/black-vue-guidebook//infrastructure/related-concepts">相关概念</a><ul><li><a href="/black-vue-guidebook//infrastructure/related-concepts/mvvm"><span>MVVM</span></a></li><li><a href="/black-vue-guidebook//infrastructure/related-concepts/proxy"><span>Proxy</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="响应性核心代码结构" data-depth="2"><a href="/black-vue-guidebook//infrastructure/vue3/reactivity#响应性核心代码结构"><span>响应性核心代码结构</span></a></li><li title="响应性实现原理" data-depth="2"><a href="/black-vue-guidebook//infrastructure/vue3/reactivity#响应性实现原理"><span>响应性实现原理</span></a></li><li title="依赖收集" data-depth="3"><a href="/black-vue-guidebook//infrastructure/vue3/reactivity#依赖收集"><span>依赖收集</span></a></li><li title="派发通知" data-depth="3"><a href="/black-vue-guidebook//infrastructure/vue3/reactivity#派发通知"><span>派发通知</span></a></li><li title="副作用函数" data-depth="3"><a href="/black-vue-guidebook//infrastructure/vue3/reactivity#副作用函数"><span>副作用函数</span></a></li><li title="响应性实现优化" data-depth="2"><a href="/black-vue-guidebook//infrastructure/vue3/reactivity#响应性实现优化"><span>响应性实现优化</span></a></li><li title="参考资料" data-depth="2"><a href="/black-vue-guidebook//infrastructure/vue3/reactivity#参考资料"><span>参考资料</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="响应性原理"><a aria-hidden="true" tabindex="-1" href="/black-vue-guidebook//infrastructure/vue3/reactivity#响应性原理"><span class="icon icon-link"></span></a>响应性原理</h1><p>阅读本文档前建议阅读官方关于响应式原理的文档 <a target="_blank" rel="noopener noreferrer" href="https://v3.cn.vuejs.org/guide/reactivity.html">深入响应性原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a target="_blank" rel="noopener noreferrer" href="https://v3.cn.vuejs.org/guide/reactivity-fundamentals.html">响应性原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 和 <a target="_blank" rel="noopener noreferrer" href="https://v3.cn.vuejs.org/guide/reactivity-computed-watchers.html">响应式计算和侦听<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><h2 id="响应性核心代码结构"><a aria-hidden="true" tabindex="-1" href="/black-vue-guidebook//infrastructure/vue3/reactivity#响应性核心代码结构"><span class="icon icon-link"></span></a>响应性核心代码结构</h2><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token builtin class-name">.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">├── LICENSE</span></div><div class="token-line"><span class="token plain">├── README.md</span></div><div class="token-line"><span class="token plain">├── __tests__                         </span><span class="token comment"># 单元测试目录</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">│   ├── collections</span></div><div class="token-line"><span class="token plain">│   │   ├── Map.spec.ts</span></div><div class="token-line"><span class="token plain">│   │   ├── Set.spec.ts</span></div><div class="token-line"><span class="token plain">│   │   ├── WeakMap.spec.ts</span></div><div class="token-line"><span class="token plain">│   │   └── WeakSet.spec.ts</span></div><div class="token-line"><span class="token plain">│   ├── computed.spec.ts</span></div><div class="token-line"><span class="token plain">│   ├── effect.spec.ts</span></div><div class="token-line"><span class="token plain">│   ├── reactive.spec.ts</span></div><div class="token-line"><span class="token plain">│   ├── reactiveArray.spec.ts</span></div><div class="token-line"><span class="token plain">│   ├── readonly.spec.ts</span></div><div class="token-line"><span class="token plain">│   └── ref.spec.ts</span></div><div class="token-line"><span class="token plain">├── api-extractor.json</span></div><div class="token-line"><span class="token plain">├── index.js</span></div><div class="token-line"><span class="token plain">├── package.json</span></div><div class="token-line"><span class="token plain">└── src</span></div><div class="token-line"><span class="token plain">    ├── baseHandlers.ts                 </span><span class="token comment"># 基本类型的处理器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    ├── collectionHandlers.ts           </span><span class="token comment"># Set Map WeakSet WeckMap的处理器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    ├── computed.ts                     </span><span class="token comment"># 计算属性，同Vue2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    ├── effect.ts                       </span><span class="token comment"># reactive 核心，处理依赖收集，依赖更新</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    ├── index.ts</span></div><div class="token-line"><span class="token plain">    ├── operations.ts                   </span><span class="token comment"># 定义依赖收集，依赖更新的类型</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    ├── reactive.ts                     </span><span class="token comment"># reactive 入口，内部主要以Proxy实现</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    └── ref.ts                          </span><span class="token comment"># reactive 的变种方法，Proxy处理不了值类型的响应，Ref来处理</span></div></pre></div><br/></div><img alt="Reactivity工作流程" src="/black-vue-guidebook/static/vue3-reactivity-workflow.18e60bc0.png" width="960"/><div class="markdown"><h2 id="响应性实现原理"><a aria-hidden="true" tabindex="-1" href="/black-vue-guidebook//infrastructure/vue3/reactivity#响应性实现原理"><span class="icon icon-link"></span></a>响应性实现原理</h2><p>所谓响应式，就是当我们修改数据后，可以自动做某些事情；对应到组件的渲染，就是修改数据后，能自动触发组件的重新渲染。</p><p>Vue 3 实现响应式，本质上是通过 Proxy API 劫持了数据对象的读写：</p><ul><li>当我们访问数据时，会触发 <code>getter</code> 执行依赖收集；</li><li>修改数据时，会触发 <code>setter</code> 派发通知。</li></ul><p>接下来，我们简单分析一下依赖收集和派发通知的实现（Vue.js 3.2 之前的版本）。</p><h3 id="依赖收集"><a aria-hidden="true" tabindex="-1" href="/black-vue-guidebook//infrastructure/vue3/reactivity#依赖收集"><span class="icon icon-link"></span></a>依赖收集</h3><p>首先来看依赖收集的过程，核心就是在访问响应式数据的时候，触发 <code>getter</code> 函数，进而执行 <code>track</code> 函数收集依赖：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// 是否应该跟踪</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> shouldTrack </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 当前激活的 effect</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> activeEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 原始数据对象 map</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> targetMap </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token parameter punctuation">,</span><span class="token parameter"> type</span><span class="token parameter punctuation">,</span><span class="token parameter"> key</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">shouldTrack </span><span class="token operator">||</span><span class="token plain"> activeEffect </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> depsMap </span><span class="token operator">=</span><span class="token plain"> targetMap</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">depsMap</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 每个 target 对应一个 depsMap</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    targetMap</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">depsMap </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> dep </span><span class="token operator">=</span><span class="token plain"> depsMap</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">dep</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 每个 key 对应一个 dep 集合</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    depsMap</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">dep </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">dep</span><span class="token punctuation">.</span><span class="token method function property-access">has</span><span class="token punctuation">(</span><span class="token plain">activeEffect</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 收集当前激活的 effect 作为依赖</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    dep</span><span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token plain">activeEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 当前激活的 effect 收集 dep 集合作为依赖</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    activeEffect</span><span class="token punctuation">.</span><span class="token property-access">deps</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">dep</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>分析这个函数的实现前，我们先想一下要收集的依赖是什么，我们的目的是实现响应式，就是当数据变化的时候可以自动做一些事情，比如执行某些函数，所以我们收集的依赖就是数据变化后执行的<strong>副作用函数</strong>。</p><p><code>track</code> 函数拥有三个参数：</p><ul><li>其中 <code>target</code> 表示原始数据；</li><li><code>type</code> 表示这次依赖收集的类型；</li><li><code>key</code> 表示访问的属性。</li></ul><p><code>track</code> 函数外部创建了全局的 <code>targetMap</code> 作为原始数据对象的 <code>Map</code>，它的键是 <code>target</code>，值是 <code>depsMap</code>，作为依赖的 <code>Map</code>；这个 <code>depsMap</code> 的键是 <code>target</code> 的 <code>key</code>，值是 <code>dep</code> 集合，<code>dep</code> 集合中存储的是依赖的副作用函数。为了方便理解，可以通过下图表示它们之间的关系：</p></div><img alt="Virtual DOM" src="/black-vue-guidebook/static/reactive-target-map.20d7910f.png" width="520"/><div class="markdown"><p>因此每次执行 <code>track</code> 函数，就是把当前激活的副作用函数 <code>activeEffect</code> 作为依赖，然后收集到 <code>target</code> 相关的 <code>depsMap</code> 对应 <code>key</code> 下的依赖集合 <code>dep</code> 中。</p><h3 id="派发通知"><a aria-hidden="true" tabindex="-1" href="/black-vue-guidebook//infrastructure/vue3/reactivity#派发通知"><span class="icon icon-link"></span></a>派发通知</h3><p>派发通知发生在数据更新的阶段，核心就是在修改响应式数据时，触发 <code>setter</code> 函数，进而执行 <code>trigger</code> 函数派发通知:</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// 键只能是对象</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> targetMap </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token parameter punctuation">,</span><span class="token parameter"> type</span><span class="token parameter punctuation">,</span><span class="token parameter"> key</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 通过 targetMap 拿到 target 对应的依赖集合</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> depsMap </span><span class="token operator">=</span><span class="token plain"> targetMap</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">depsMap</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 没有依赖，直接返回</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 创建运行的 effects 集合</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> effects </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 添加 effects 的函数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">add</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">effectsToAdd</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">effectsToAdd</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      effectsToAdd</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">effect</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        effects</span><span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token plain">effect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// SET | ADD | DELETE 操作之一，添加对应的 effects</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">key </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">add</span><span class="token punctuation">(</span><span class="token plain">depsMap</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">run</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">effect</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 调度执行</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">effect</span><span class="token punctuation">.</span><span class="token property-access">options</span><span class="token punctuation">.</span><span class="token property-access">scheduler</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      effect</span><span class="token punctuation">.</span><span class="token property-access">options</span><span class="token punctuation">.</span><span class="token method function property-access">scheduler</span><span class="token punctuation">(</span><span class="token plain">effect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 直接运行</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 遍历执行 effects</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  effects</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token plain">run</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p><code>trigger</code> 函数拥有三个参数，其中 <code>target</code> 表示目标原始对象；<code>type</code> 表示更新的类型；<code>key</code> 表示要修改的属性。</p><p><code>trigger</code> 函数 主要做了四件事情：</p><ol><li>从 <code>targetMap</code> 中拿到 <code>target</code> 对应的依赖集合 <code>depsMap</code>；</li><li>创建运行的 <code>effects</code> 集合；</li><li>根据 <code>key</code> 从 <code>depsMap</code> 中找到对应的 <code>effect</code> 添加到 <code>effects</code> 集合；</li><li>遍历 <code>effects</code> 执行相关的副作用函数。</li></ol><p>因此每次执行 <code>trigger</code> 函数，就是根据 <code>target</code> 和 <code>key</code>，从 <code>targetMap</code> 中找到相关的所有副作用函数遍历执行一遍。 在描述依赖收集和派发通知的过程中，我们都提到了一个词：副作用函数，依赖收集过程中我们把 <code>activeEffect</code>（当前激活副作用函数）作为依赖收集，它又是什么？接下来我们来看一下副作用函数的庐山真面目。</p><h3 id="副作用函数"><a aria-hidden="true" tabindex="-1" href="/black-vue-guidebook//infrastructure/vue3/reactivity#副作用函数"><span class="icon icon-link"></span></a>副作用函数</h3><p>那么，什么是副作用函数，在介绍它之前，我们先回顾一下响应式的原始需求，即我们修改了数据就能自动做某些事情，举个简单的例子：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports punctuation">{</span><span class="token imports"> reactive </span><span class="token imports punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;vue&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> counter </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  num</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">logCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">counter</span><span class="token punctuation">.</span><span class="token property-access">num</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  counter</span><span class="token punctuation">.</span><span class="token property-access">num</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">logCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>我们定义了响应式对象 counter，然后在 logCount 中访问了 counter.num，我们希望在执行 count 函数修改 counter.num 值的时候，能自动执行 logCount 函数。 按我们之前对依赖收集过程的分析，如果 logCount 是 activeEffect 的话，那么就可以实现需求，但显然是做不到的，因为代码在执行到 console.log(counter.num) 这一行的时候，它对自己在 logCount 函数中的运行是一无所知的。 那么该怎么办呢？其实只要我们运行 logCount 函数前，把 logCount 赋值给 activeEffect 就好了：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">activeEffect </span><span class="token operator">=</span><span class="token plain"> logCount</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">logCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>顺着这个思路，我们可以利用高阶函数的思想，对 logCount 做一层封装：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">wrapped</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter operator">...</span><span class="token parameter">args</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    activeEffect </span><span class="token operator">=</span><span class="token plain"> fn</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token plain">args</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> wrapped</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> wrappedLog </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token plain">logCount</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">wrappedLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>wrapper 本身也是一个函数，它接受 fn 作为参数，返回一个新的函数 wrapped，然后维护一个全局变量 activeEffect，当 wrapped 执行的时候，把 activeEffect 设置为 fn，然后执行 fn 即可。 这样当我们执行 wrappedLog 后，再去修改 counter.num，就会自动执行 logCount 函数了。</p><p>实际上 Vue 3 就是采用类似的做法，在它内部就有一个 effect 副作用函数，我们来看一下它的实现：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// 全局 effect 栈</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> effectStack </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 当前激活的 effect</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> activeEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token parameter punctuation">,</span><span class="token parameter"> options </span><span class="token parameter operator">=</span><span class="token parameter"> EMPTY_OBJ</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">isEffect</span><span class="token punctuation">(</span><span class="token plain">fn</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 如果 fn 已经是一个 effect 函数了，则指向</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    fn </span><span class="token operator">=</span><span class="token plain"> fn</span><span class="token punctuation">.</span><span class="token property-access">raw</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 创建一个 wrapper，它是一个响应式的副作用的函数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> effect </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createReactiveEffect</span><span class="token punctuation">(</span><span class="token plain">fn</span><span class="token punctuation">,</span><span class="token plain"> options</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">options</span><span class="token punctuation">.</span><span class="token property-access">lazy</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// lazy 配置，计算属性会用到，非 lazy 则直接执行一次</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> effect</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createReactiveEffect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token parameter punctuation">,</span><span class="token parameter"> options</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">effect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">reactiveEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">effect</span><span class="token punctuation">.</span><span class="token property-access">active</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 非激活状态，则判断如果非调度执行，则直接执行原始函数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">scheduler</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">effectStack</span><span class="token punctuation">.</span><span class="token method function property-access">includes</span><span class="token punctuation">(</span><span class="token plain">effect</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 清空 effect 引用的依赖</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token plain">effect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 开启全局 shouldTrack，允许依赖收集</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">enableTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 压栈</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        effectStack</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">effect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        activeEffect </span><span class="token operator">=</span><span class="token plain"> effect</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 执行原始函数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">finally</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 出栈</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        effectStack</span><span class="token punctuation">.</span><span class="token method function property-access">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 恢复 shouldTrack 开启之前的状态</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">resetTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 指向栈最后一个 effect</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        activeEffect </span><span class="token operator">=</span><span class="token plain"> effectStack</span><span class="token punctuation">[</span><span class="token plain">effectStack</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  effect</span><span class="token punctuation">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> uid</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 标识是一个 effect 函数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  effect</span><span class="token punctuation">.</span><span class="token property-access">_isEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// effect 自身的状态</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  effect</span><span class="token punctuation">.</span><span class="token property-access">active</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 包装的原始函数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  effect</span><span class="token punctuation">.</span><span class="token property-access">raw</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fn</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// effect 对应的依赖，双向指针，依赖包含对 effect 的引用，effect 也包含对依赖的引用</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  effect</span><span class="token punctuation">.</span><span class="token property-access">deps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// effect 的相关配置</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  effect</span><span class="token punctuation">.</span><span class="token property-access">options</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> effect</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>结合上述代码来看，effect 内部通过执行 createReactiveEffect 函数去创建一个新的 effect 函数，为了和外部的 effect 函数区分，我们把它称作 reactiveEffect 函数，并且还给它添加了一些额外属性（我在注释中都有标明）。另外，effect 函数还支持传入一个配置参数以支持更多的 feature，这里就不展开了。 reactiveEffect 函数就是响应式的副作用函数，当执行 trigger 过程派发通知的时候，执行的 effect 就是它。 按我们之前的分析，reactiveEffect 函数只需要做两件事情：让全局的 activeEffect 指向它， 然后执行被包装的原始函数 fn。 但实际上它的实现要更复杂一些，首先它会判断 effect 的状态是否是 active，这其实是一种控制手段，允许在非 active 状态且非调度执行情况，则直接执行原始函数 fn 并返回。 接着判断 effectStack 中是否包含 effect，如果没有就把 effect 压入栈内。之前我们提到，只要设置 activeEffect = effect 即可，那么这里为什么要设计一个栈的结构呢？ 其实是考虑到以下这样一个嵌套 effect 的场景：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports punctuation">{</span><span class="token imports"> reactive </span><span class="token imports punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;vue&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports punctuation">{</span><span class="token imports"> effect </span><span class="token imports punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;@vue/reactivity&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> counter </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  num</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  num2</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">logCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token plain">logCount2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;num:&#x27;</span><span class="token punctuation">,</span><span class="token plain"> counter</span><span class="token punctuation">.</span><span class="token property-access">num</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  counter</span><span class="token punctuation">.</span><span class="token property-access">num</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">logCount2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;num2:&#x27;</span><span class="token punctuation">,</span><span class="token plain"> counter</span><span class="token punctuation">.</span><span class="token property-access">num2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token plain">logCount</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>我们每次执行 effect 函数时，如果仅仅把 reactiveEffect 函数赋值给 activeEffect，那么针对这种嵌套场景，执行完 effect(logCount2) 后，activeEffect 还是 effect(logCount2) 返回的 reactiveEffect 函数，这样后续访问 counter.num 的时候，依赖收集对应的 activeEffect 就不对了，此时我们外部执行 count 函数修改 counter.num 后执行的便不是 logCount 函数，而是 logCount2 函数，最终输出的结果如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">num2: 0</span></div><div class="token-line"><span class="token plain">num: 0</span></div><div class="token-line"><span class="token plain">num2: 0</span></div></pre></div><p>而我们期望的结果应该如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">num2</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">num</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">num2</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">num</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span></div></pre></div><p>因此针对嵌套 effect 的场景，我们不能简单地赋值 activeEffect，应该考虑到函数的执行本身就是一种入栈出栈操作，因此我们也可以设计一个 effectStack，这样每次进入 reactiveEffect 函数就先把它入栈，然后 activeEffect 指向这个 reactiveEffect 函数，接着在 fn 执行完毕后出栈，再把 activeEffect 指向 effectStack 最后一个元素，也就是外层 effect 函数对应的 reactiveEffect。 这里我们还注意到一个细节，在入栈前会执行 cleanup 函数清空 reactiveEffect 函数对应的依赖 。在执行 track 函数的时候，除了收集当前激活的 effect 作为依赖，还通过 activeEffect.deps.push(dep) 把 dep 作为 activeEffect 的依赖，这样在 cleanup 的时候我们就可以找到 effect 对应的 dep 了，然后把 effect 从这些 dep 中删除。cleanup 函数的代码如下所示：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token parameter">effect</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> deps </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> effect</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">deps</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> deps</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      deps</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">delete</span><span class="token punctuation">(</span><span class="token plain">effect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    deps</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>为什么需要 cleanup 呢？如果遇到这种场景：</p><div class="__dumi-default-code-block"><pre class="prism-code language-vue"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;template&gt;</span></div><div class="token-line"><span class="token plain">  &lt;div v-if=&quot;state.showMsg&quot;&gt;</span></div><div class="token-line"><span class="token plain">    {{ state.msg }}</span></div><div class="token-line"><span class="token plain">  &lt;/div&gt;</span></div><div class="token-line"><span class="token plain">  &lt;div v-else&gt;</span></div><div class="token-line"><span class="token plain">    {{ Math.random() }}</span></div><div class="token-line"><span class="token plain">  &lt;/div&gt;</span></div><div class="token-line"><span class="token plain">  &lt;button @click=&quot;toggle&quot;&gt;Toggle Msg&lt;/button&gt;</span></div><div class="token-line"><span class="token plain">  &lt;button @click=&quot;switchView&quot;&gt;Switch View&lt;/button&gt;</span></div><div class="token-line"><span class="token plain">&lt;/template&gt;</span></div><div class="token-line"><span class="token plain">&lt;script&gt;</span></div><div class="token-line"><span class="token plain">import { reactive } from &#x27;vue&#x27;;</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">export default {</span></div><div class="token-line"><span class="token plain">  setup() {</span></div><div class="token-line"><span class="token plain">    const state = reactive({</span></div><div class="token-line"><span class="token plain">      msg: &#x27;Hello World&#x27;,</span></div><div class="token-line"><span class="token plain">      showMsg: true,</span></div><div class="token-line"><span class="token plain">    });</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    function toggle() {</span></div><div class="token-line"><span class="token plain">      state.msg = state.msg === &#x27;Hello World&#x27; ? &#x27;Hello Vue&#x27; : &#x27;Hello World&#x27;;</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    function switchView() {</span></div><div class="token-line"><span class="token plain">      state.showMsg = !state.showMsg;</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    return {</span></div><div class="token-line"><span class="token plain">      toggle,</span></div><div class="token-line"><span class="token plain">      switchView,</span></div><div class="token-line"><span class="token plain">      state,</span></div><div class="token-line"><span class="token plain">    };</span></div><div class="token-line"><span class="token plain">  },</span></div><div class="token-line"><span class="token plain">};</span></div><div class="token-line"><span class="token plain">&lt;/script&gt;</span></div></pre></div><p>结合代码可以知道，这个组件的视图会根据 showMsg 变量的控制显示 msg 或者一个随机数，当我们点击 Switch View 的按钮时，就会修改这个变量值。 假设没有 cleanup，在第一次渲染模板的时候，activeEffect 是组件的副作用渲染函数，因为模板 render 的时候访问了 state.msg，所以会执行依赖收集，把副作用渲染函数作为 state.msg 的依赖，我们把它称作 render effect。然后我们点击 Switch View 按钮，视图切换为显示随机数，此时我们再点击 Toggle Msg 按钮，由于修改了 state.msg 就会派发通知，找到了 render effect 并执行，就又触发了组件的重新渲染。 但这个行为实际上并不符合预期，因为当我们点击 Switch View 按钮，视图切换为显示随机数的时候，也会触发组件的重新渲染，但这个时候视图并没有渲染 state.msg，所以对它的改动并不应该影响组件的重新渲染。 因此在组件的 render effect 执行之前，如果通过 cleanup 清理依赖，我们就可以删除之前 state.msg 收集的 render effect 依赖。这样当我们修改 state.msg 时，由于已经没有依赖了就不会触发组件的重新渲染，符合预期。</p><h2 id="响应性实现优化"><a aria-hidden="true" tabindex="-1" href="/black-vue-guidebook//infrastructure/vue3/reactivity#响应性实现优化"><span class="icon icon-link"></span></a>响应性实现优化</h2><p>响应性实现的优化：</p><ol><li>依赖收集的优化</li><li>响应性 API 的优化</li><li>trackOpBit 的设计</li></ol><h2 id="参考资料"><a aria-hidden="true" tabindex="-1" href="/black-vue-guidebook//infrastructure/vue3/reactivity#参考资料"><span class="icon icon-link"></span></a>参考资料</h2><ul><li><a target="_blank" rel="noopener noreferrer" href="https://juejin.cn/post/6995732683435278344">细说 Vue.js 3.2 关于响应式部分的优化<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><hr/><p><a target="_blank" rel="noopener noreferrer" href="https://github.com/vuejs/vue-next/blob/master/packages/reactivity/README.md"><code>/package/reactivity</code></a></p><ol><li>通过 <code>reactive</code> 来定义响应式数据</li><li>通过 <code>effect</code> 声明依赖响应式数据的函数 <code>cb</code>（例如视图渲染函数 render 函数），并执行 <code>cb</code> 函数，执行过程中，会触发响应式数据 <code>getter</code></li><li>在响应式数据 <code>getter</code> 中进行 <code>track</code> 依赖收集：存储响应式数据与更新函数 <code>cb</code> 的映射关系，存储于 <code>targetMap</code></li><li>当变更响应式数据时，触发 <code>trigger</code>，根据 <code>targetMap</code> 找到关联的 <code>cb</code> 并执行</li></ol><hr/><ol><li>当一个值被读取时进行追踪：<code>proxy</code> 的 <code>get</code> 处理函数中 <code>track</code> 函数记录了该 <code>property</code> 和当前副作用</li><li>当某个值改变时进行检测：在 <code>proxy</code> 上调用 <code>set</code> 处理函数</li><li>重新运行代码来读取原始值：<code>trigger</code> 函数查找哪些副作用依赖于该 <code>property</code> 并执行它们</li></ol><p>该被代理的对象对于用户来说是不可见的，但是在内部，它们使 Vue 能够在 property 的值被访问或修改的情况下进行依赖跟踪和变更通知。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-vue-guidebook/edit/master/docs/infrastructure/vue3/reactivity.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">2023/7/9 19:08:07</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/black-vue-guidebook/umi.aa026cf3.js"></script>
  </body>
</html>
